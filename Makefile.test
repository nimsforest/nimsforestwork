# =============================================================================
# NimsforestWork Test Suite - Essential Tests Only
# =============================================================================
#
# Simple test suite covering core functionality
#
# Usage:
#   make -f Makefile.test test         # Run all tests
#   make -f Makefile.test test-cleanup # Clean up test directories
#

# Test configuration
TEST_DIR := /tmp/nimsforestwork-tests
NIMSFORESTWORK_PATH := $(shell pwd)

# Colors for output
GREEN := \033[0;32m
RED := \033[0;31m
BLUE := \033[0;34m
NC := \033[0m

.PHONY: test test-cleanup test-setup test-hello test-init test-workspace test-templates

# Run all essential tests
test: test-setup test-hello test-init test-workspace test-templates
	@echo "=================================="
	@echo -e "$(GREEN)âœ“ All essential tests passed$(NC)"
	@echo -e "$(BLUE)ðŸŽ‰ NimsforestWork is working correctly!$(NC)"

# Test environment setup
test-setup:
	@echo -e "$(BLUE)[INFO]$(NC) Setting up test environment..."
	@rm -rf $(TEST_DIR)
	@mkdir -p $(TEST_DIR)

# Test cleanup
test-cleanup:
	@echo -e "$(BLUE)[INFO]$(NC) Cleaning up test directories..."
	@rm -rf $(TEST_DIR)
	@echo -e "$(GREEN)[PASS]$(NC) Cleanup complete"

# Create simple mock repo
define create-mock-repo
	@mkdir -p $(TEST_DIR)/$(1)
	@cd $(TEST_DIR)/$(1) && \
		git init --quiet && \
		git config user.name "Test User" && \
		git config user.email "test@example.com" && \
		echo "# $(1)" > README.md && \
		git add . && \
		git commit --quiet -m "Initial commit"
endef

# Test 1: Basic compatibility check
test-hello:
	@echo -e "$(BLUE)[INFO]$(NC) Testing basic functionality..."
	@$(call create-mock-repo,test-hello)
	@cd $(TEST_DIR)/test-hello && \
		mkdir -p tools && \
		cp -r $(NIMSFORESTWORK_PATH) tools/nimsforestwork && \
		rm -rf tools/nimsforestwork/.git && \
		make -f tools/nimsforestwork/MAKEFILE.nimsforestwork nimsforestwork-hello >/dev/null 2>&1 && \
		echo -e "$(GREEN)[PASS]$(NC) Basic functionality works" || \
		(echo -e "$(RED)[FAIL]$(NC) Basic functionality failed" && exit 1)

# Test 2: Traditional initialization
test-init:
	@echo -e "$(BLUE)[INFO]$(NC) Testing project initialization..."
	@$(call create-mock-repo,test-init)
	@cd $(TEST_DIR)/test-init && \
		mkdir -p tools && \
		cp -r $(NIMSFORESTWORK_PATH) tools/nimsforestwork && \
		rm -rf tools/nimsforestwork/.git && \
		make -f tools/nimsforestwork/MAKEFILE.nimsforestwork nimsforestwork-init >/dev/null 2>&1 && \
		test -d docs/work/proposals && \
		test -d docs/work/bugs && \
		echo -e "$(GREEN)[PASS]$(NC) Project initialization works" || \
		(echo -e "$(RED)[FAIL]$(NC) Project initialization failed" && exit 1)

# Test 3: Workspace setup
test-workspace:
	@echo -e "$(BLUE)[INFO]$(NC) Testing workspace setup..."
	@$(call create-mock-repo,test-workspace)
	@cd $(TEST_DIR)/test-workspace && \
		mkdir -p tools && \
		cp -r $(NIMSFORESTWORK_PATH) tools/nimsforestwork && \
		rm -rf tools/nimsforestwork/.git && \
		WORKSPACE_ROOT=$(TEST_DIR)/test-workspace-ws \
		make -f tools/nimsforestwork/MAKEFILE.nimsforestwork nimsforestwork-setup-workspace >/dev/null 2>&1 && \
		test -d $(TEST_DIR)/test-workspace-ws/main && \
		test -d $(TEST_DIR)/test-workspace-ws/work && \
		test -f $(TEST_DIR)/test-workspace-ws/Makefile && \
		echo -e "$(GREEN)[PASS]$(NC) Workspace setup works" || \
		(echo -e "$(RED)[FAIL]$(NC) Workspace setup failed" && exit 1)

# Test 4: Templates validation
test-templates:
	@echo -e "$(BLUE)[INFO]$(NC) Testing templates..."
	@$(call create-mock-repo,test-templates)
	@cd $(TEST_DIR)/test-templates && \
		mkdir -p tools && \
		cp -r $(NIMSFORESTWORK_PATH) tools/nimsforestwork && \
		rm -rf tools/nimsforestwork/.git && \
		make -f tools/nimsforestwork/MAKEFILE.nimsforestwork nimsforestwork-init >/dev/null 2>&1 && \
		test -f docs/work/proposals/template.md && \
		test -f docs/work/bugs/template.md && \
		test -f docs/work/changerequests/template.md && \
		test -f docs/work/improvedocumentation/template.md && \
		echo -e "$(GREEN)[PASS]$(NC) Templates work correctly" || \
		(echo -e "$(RED)[FAIL]$(NC) Templates failed" && exit 1)